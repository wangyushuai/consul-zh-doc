# ACL系统

1.4.0及更高版本：本指南仅适用于Consul 1.4.0及更高版本。 旧版ACL系统的文档在[这里](https://www.consul.io/docs/acl/acl-legacy)。

Consul提供了一个可选的访问控制列表（ACL）系统，可用于控制对数据和API的访问。ACL是[基于能力的](https://en.wikipedia.org/wiki/Capability-based_security)\(_系统的安全模型之一_\)，依靠与策略相关联的令牌来确定可以应用哪些细粒度的规则。Consul的基于能力的ACL系统与[AWS IAM](https://aws.amazon.com/iam/)的设计非常相似。

 要了解如何在现有Consul数据中心上设置ACL系统，请使[用Bootstrapping ACL System教程](https://learn.hashicorp.com/tutorials/consul/access-control-setup?utm_source=consul.io&utm_medium=docs)。

## [»](acl-system.md#acl-system-overview)ACL系统概览

ACL系统的设计是为了便于使用和快速执行，同时提供管理方面的能力。宏观来看，ACL系统有两个主要组成部分：

* **ACL策略** -  策略允许将一组规则分组为一个逻辑单元，该逻辑单元可以重复使用并与许多令牌链接。
* **ACL令牌** - 对Consul的请求是通过使用不记名令牌授权的。每个ACL令牌都有一个公共的Accessor ID，用来命名令牌，还有一个Secret ID，作为向Consul提出请求的不记名令牌。

对于许多场景来说，政策和令牌就足够了，但更高级的设置可能会受益于ACL系统中的其他组件。

*  **ACL角色** - 角色允许将一组策略和服务标识归为一个可重复使用的较高级实体，可应用于许多令牌。\(在Consul 1.5.0中添加\) 
* **ACL服务标识** - 服务标识是一种策略模板，用于表达适合在[Consul Connect](https://www.consul.io/docs/connect)中使用的策略链接。在授权时，这就像附加了一个额外的策略，其内容将在下面进一步描述。这些都是直接附加到令牌和角色上的，而不是独立配置的。\(在Consul 1.5.0中添加\)
*  **ACL节点身份** - 节点身份是一个策略模板，用于表达一个适合作为[Consul代理令牌](https://www.consul.io/docs/agent/options#acl_tokens_agent)使用的策略链接。在授权时，这就像附加了一个额外的策略，其内容将在下面进一步描述。这些都是直接附加到令牌和角色上的，而不是独立配置的。\(在Consul 1.8.1中添加\) 
* **ACL 认证方法和绑定规则** - 要了解更多关于这些主题的内容，请参见[认证方法文档页](https://www.consul.io/docs/security/acl/auth-methods)。 

ACL令牌、策略、角色、授权方法和绑定规则由Consul操作员通过Consul的ACL API、ACL CLI或HashiCorp的Vault等系统进行管理。 

如果ACL系统无法使用，您可以在任何时候遵循[重置程序](https://learn.hashicorp.com/tutorials/consul/access-control-troubleshoot#reset-the-acl-system)。

### [»](acl-system.md#acl-policies)ACL 策略

一个ACL策略是一个命名的规则集，由以下元素组成。 

* **ID** - 策略的自动生成的公共标识符。
* **Name** - 策略的唯一有意义的名称。
* **Description** - -策略的可读描述。\(可选\)
* **Rules** - 授予或拒绝权限的一组规则。请参阅[规则规范文档](https://www.consul.io/docs/acl/acl-rules#rule-specification)了解更多详情。
* **Datacenters** - 策略有效的数据中心列表。
* **Namespace** - 企业版本，这个策略所在的命名空间。\(在Consul Enterprise 1.7.0中添加\)

**Consul Enterprise 命名空间** - 策略中定义的规则在除缺省之外的任何命名空间中都将被限制为能够授予整体权限的一个子集，并且只影响该单一命名空间。 

#### [»](acl-system.md#builtin-policies)内置策略

* **全局管理** - 授予任何使用它的令牌不受限制的权限。创建时，它将被命名为 `global-management`，并将被分配保留的 ID `00000000-0000-0000-0000-0000-00000001`。该策略可以重新命名，但其他任何东西的修改，包括规则集和数据中心范围，都将被Consul阻止。
* 命名空间管理 -

  （**企业版本**） - 每个创建的命名空间都会有一个策略，注入名称为_namespace-management_。这个策略会被注入一个随机的UUID，并且可以像其他用户定义的策略一样在命名空间中进行管理。\(在Consul Enterprise 1.7.0中添加\)

### [»](acl-system.md#acl-service-identities)ACL服务标识

Consul 1.5.0增加。

ACL服务标识是一个[ACL策略](https://www.consul.io/docs/acl/acl-system#acl-policies)模板，用于表达适合在Consul Connect中使用的策略链接。它们既可用于令牌。

* **Service Name** - 服务名称
* **Datacenters** - 策略有效的数据中心列表。 \(可选参数\)

参与服务网格的服务将需要特权来发现， 并且发现其他健康的服务实例。合适的策略往往看起来都几乎相同，所以服务标识是一个策略模板，以帮助避免创建模板策略。

在授权过程中，将使用以下预配置的ACL规则自动将配置的服务标识作为策略应用：

```text
# Allow the service and its sidecar proxy to register into the catalog.
service "<Service Name>" {
    policy = "write"
}
service "<Service Name>-sidecar-proxy" {
    policy = "write"
}

# Allow for any potential upstreams to be resolved.
service_prefix "" {
    policy = "read"
}
node_prefix "" {
    policy = "read"
}
```

[这篇用于角色的API文档](https://www.consul.io/api/acl/roles#sample-payload)有一些身份标识的例子。 

**Consul Enterprise Namespacing** - 服务标识规则的范围将限于相应ACL令牌或角色所在的单个命名空间。

### **ACL 节点标识**

在Consul 1.8.1中新增。

ACL节点标识是[ACL策略](https://www.consul.io/docs/acl/acl-system#acl-policies)模板，用于表达指向适合用作Consul代理令牌的策略的链接。 它们在令牌和角色上均可用，并且由以下元素组成：

* **Node Name** - 授权访问的节点名称
* **Datacenter** - 节点所在的数据中心

在授权过程中，配置的节点标识将自动应用为具有以下[预配置 ACL 规则策略](https://www.consul.io/docs/acl/acl-system#acl-rules-and-scope)：

```text
# Allow the agent to register its own node in the Catalog and update its network coordinates
node "<Node Name>" {
  policy = "write"
}

# Allows the agent to detect and diff services registered to itself. This is used during
# anti-entropy to reconcile difference between the agents knowledge of registered
# services and checks in comparison with what is known in the Catalog.
service_prefix "" {
  policy = "read"
}
```

**Consul Enterprise Namespacing** -节点标识只能应用于默认名称空间中的令牌和角色。综合策略规则允许对所有名称空间中的所有服务赋予`service：read`权限。

















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































，也可用于角色，并由以下元素组成：

* **Service Name** - 服务名称
* **Datacenters** - 生效的数据中心列表

参与服务网格的的服务将需要特权来发现和发现其他健康的服务实例。合适的策略往往看起来都几乎相同，所以服务标识是一个策略模板，以帮助避免创建模板策略。

在授权过程中，配置好的**服务标识**会自动作为策略应用，其预置的ACL规则如下。

```text

service "" {
    policy = "write"
}
service "-sidecar-proxy" {
    policy = "write"
}


service_prefix "" {
    policy = "read"
}
node_prefix "" {
    policy = "read"
}
```

[角色的API文档](https://www.consul.io/api/acl/roles#sample-payload)中有一些使用服务身份的例子。

**Consul Enterprise Namespacing** - 服务身份规则将被限定在对应的ACL令牌或角色所在的单一命名空间内。

### [»](acl-system.md#acl-node-identities)ACL节点身份

1.8.1版本中增加。 

ACL节点标识是一个ACL策略模板，用于表达一个适合作为Consul代理令牌使用的策略链接。它们既可用于令牌，也可用于角色，由以下要素组成：

* **Node Name** - 授予访问权限的节点名称.
* **Datacenter** - 节点所在的数据中心.

在授权过程中，节点将自动将以下ACL规则作为策略应用。 

```text

node "" {
  policy = "write"
}




service_prefix "" {
  policy = "read"
}
```

**Consul Enterprise Namespacing** - 节点身份只能应用于默认命名空间中的令牌和角色。合成策略规则允许在所有命名空间的所有服务上拥有 `service:read`权限。

### [»](acl-system.md#acl-roles)ACL角色

在Consul 1.5.0中增加。

在ACL 角色

An ACL role is a named set of policies and service identities and is composed of the following elements:

* **ID** - The role's auto-generated public identifier.
* **Name** - A unique meaningful name for the role.
* **Description** - A human readable description of the role. \(Optional\)
* **Policy Set** - The list of policies that are applicable for the role.
* **Service Identity Set** - The list of service identities that are applicable for the role.
* **Namespace**

  Enterprise - The namespace this policy resides within. \(Added in Consul Enterprise 1.7.0\)

**Consul Enterprise Namespacing** - Roles may only link to policies defined in the same namespace as the role itself.

### [»](acl-system.md#acl-tokens)ACL Tokens

ACL tokens are used to determine if the caller is authorized to perform an action. An ACL token is composed of the following elements:

* **Accessor ID** - The token's public identifier.
* **Secret ID** -The bearer token used when making requests to Consul.
* **Description** - A human readable description of the token. \(Optional\)
* **Policy Set** - The list of policies that are applicable for the token.
* **Role Set** - The list of roles that are applicable for the token. \(Added in Consul 1.5.0\)
* **Service Identity Set** - The list of service identities that are applicable for the token. \(Added in Consul 1.5.0\)
* **Locality** - Indicates whether the token should be local to the datacenter it was created within or created in the primary datacenter and globally replicated.
* **Expiration Time** - The time at which this token is revoked. \(Optional; Added in Consul 1.5.0\)
* **Namespace**

  Enterprise - The namespace this policy resides within. \(Added in Consul Enterprise 1.7.0\)

**Consul Enterprise Namespacing** - Tokens may only link to policies and roles defined in the same namespace as the token itself.

#### [»](acl-system.md#builtin-tokens)Builtin Tokens

During cluster bootstrapping when ACLs are enabled both the special `anonymous` and the `master` token will be injected.

* **Anonymous Token** - The anonymous token is used when a request is made to Consul without specifying a bearer token. The anonymous token's description and policies may be updated but Consul will prevent this token's deletion. When created, it will be assigned `00000000-0000-0000-0000-000000000002` for its Accessor ID and `anonymous` for its Secret ID.
* **Master Token** - When a master token is present within the Consul configuration, it is created and will be linked With the builtin Global Management policy giving it unrestricted privileges. The master token is created with the Secret ID set to the value of the configuration entry.

#### [»](acl-system.md#authorization)Authorization

The token Secret ID is passed along with each RPC request to the servers. Consul's [HTTP endpoints](https://www.consul.io/api) can accept tokens via the `token` query string parameter, the `X-Consul-Token` request header, or an [RFC6750](https://tools.ietf.org/html/rfc6750) authorization bearer token. Consul's [CLI commands](https://www.consul.io/docs/commands) can accept tokens via the `token` argument, or the `CONSUL_HTTP_TOKEN` environment variable. The CLI commands can also accept token values stored in files with the `token-file` argument, or the `CONSUL_HTTP_TOKEN_FILE` environment variable.

If no token is provided for an HTTP request then Consul will use the default ACL token if it has been configured. If no default ACL token was configured then the anonymous token will be used.

#### [»](acl-system.md#acl-rules-and-scope)ACL Rules and Scope

The rules from all policies, roles, and service identities linked with a token are combined to form that token's effective rule set. Policy rules can be defined in either an allowlist or denylist mode depending on the configuration of [`acl_default_policy`](https://www.consul.io/docs/agent/options#acl_default_policy). If the default policy is to "deny" access to all resources, then policy rules can be set to allowlist access to specific resources. Conversely, if the default policy is “allow” then policy rules can be used to explicitly deny access to resources.

The following table summarizes the ACL resources that are available for constructing rules:

| Resource | Scope |
| :--- | :--- |
| [`acl`](https://www.consul.io/docs/acl/acl-rules#acl-resource-rules) | Operations for managing the ACL system [ACL API](https://www.consul.io/api/acl/acl) |
| [`agent`](https://www.consul.io/docs/acl/acl-rules#agent-rules) | Utility operations in the [Agent API](https://www.consul.io/api/agent), other than service and check registration |
| [`event`](https://www.consul.io/docs/acl/acl-rules#event-rules) | Listing and firing events in the [Event API](https://www.consul.io/api/event) |
| [`key`](https://www.consul.io/docs/acl/acl-rules#key-value-rules) | Key/value store operations in the [KV Store API](https://www.consul.io/api/kv) |
| [`keyring`](https://www.consul.io/docs/acl/acl-rules#keyring-rules) | Keyring operations in the [Keyring API](https://www.consul.io/api/operator/keyring) |
| [`node`](https://www.consul.io/docs/acl/acl-rules#node-rules) | Node-level catalog operations in the [Catalog API](https://www.consul.io/api/catalog), [Health API](https://www.consul.io/api/health), [Prepared Query API](https://www.consul.io/api/query), [Network Coordinate API](https://www.consul.io/api/coordinate), and [Agent API](https://www.consul.io/api/agent) |
| [`operator`](https://www.consul.io/docs/acl/acl-rules#operator-rules) | Cluster-level operations in the [Operator API](https://www.consul.io/api/operator), other than the [Keyring API](https://www.consul.io/api/operator/keyring) |
| [`query`](https://www.consul.io/docs/acl/acl-rules#prepared-query-rules) | Prepared query operations in the [Prepared Query API](https://www.consul.io/api/query) |
| [`service`](https://www.consul.io/docs/acl/acl-rules#service-rules) | Service-level catalog operations in the [Catalog API](https://www.consul.io/api/catalog), [Health API](https://www.consul.io/api/health), [Prepared Query API](https://www.consul.io/api/query), and [Agent API](https://www.consul.io/api/agent) |
| [`session`](https://www.consul.io/docs/acl/acl-rules#session-rules) | Session operations in the [Session API](https://www.consul.io/api/session) |

Since Consul snapshots actually contain ACL tokens, the [Snapshot API](https://www.consul.io/api/snapshot) requires a token with "write" privileges for the ACL system.

The following resources are not covered by ACL policies:

1. The [Status API](https://www.consul.io/api/status) is used by servers when bootstrapping and exposes basic IP and port information about the servers, and does not allow modification of any state.
2. The datacenter listing operation of the [Catalog API](https://www.consul.io/api/catalog#list-datacenters) similarly exposes the names of known Consul datacenters, and does not allow modification of any state.
3. The [connect CA roots endpoint](https://www.consul.io/api/connect/ca#list-ca-root-certificates) exposes just the public TLS certificate which other systems can use to verify the TLS connection with Consul.

Constructing rules from these policies is covered in detail on the [ACL Rules](https://www.consul.io/docs/acl/acl-rules) page.

**Consul Enterprise Namespacing** - In addition to directly linked policies, roles and service identities, Consul Enterprise will include the ACL policies and roles defined in the [Namespaces definition](https://www.consul.io/docs/enterprise/namespaces#namespace-definition). \(Added in Consul Enterprise 1.7.0\)

## [»](acl-system.md#configuring-acls)Configuring ACLs

ACLs are configured using several different configuration options. These are marked as to whether they are set on servers, clients, or both.

| Configuration Option | Servers | Clients | Purpose |
| :--- | :--- | :--- | :--- |
| [`acl.enabled`](https://www.consul.io/docs/agent/options#acl_enabled) | `REQUIRED` | `REQUIRED` | Controls whether ACLs are enabled |
| [`acl.default_policy`](https://www.consul.io/docs/agent/options#acl_default_policy) | `OPTIONAL` | `N/A` | Determines allowlist or denylist mode |
| [`acl.down_policy`](https://www.consul.io/docs/agent/options#acl_down_policy) | `OPTIONAL` | `OPTIONAL` | Determines what to do when the remote token or policy resolution fails |
| [`acl.role_ttl`](https://www.consul.io/docs/agent/options#acl_role_ttl) | `OPTIONAL` | `OPTIONAL` | Determines time-to-live for cached ACL Roles |
| [`acl.policy_ttl`](https://www.consul.io/docs/agent/options#acl_policy_ttl) | `OPTIONAL` | `OPTIONAL` | Determines time-to-live for cached ACL Policies |
| [`acl.token_ttl`](https://www.consul.io/docs/agent/options#acl_token_ttl) | `OPTIONAL` | `OPTIONAL` | Determines time-to-live for cached ACL Tokens |

A number of special tokens can also be configured which allow for bootstrapping the ACL system, or accessing Consul in special situations:

| Special Token | Servers | Clients | Purpose |
| :--- | :--- | :--- | :--- |
| [`acl.tokens.agent_master`](https://www.consul.io/docs/agent/options#acl_tokens_agent_master) | `OPTIONAL` | `OPTIONAL` | Special token that can be used to access [Agent API](https://www.consul.io/api/agent) when remote bearer token resolution fails; used for setting up the cluster such as doing initial join operations, see the [ACL Agent Master Token](acl-system.md#acl-agent-master-token) section for more details |
| [`acl.tokens.agent`](https://www.consul.io/docs/agent/options#acl_tokens_agent) | `OPTIONAL` | `OPTIONAL` | Special token that is used for an agent's internal operations, see the [ACL Agent Token](acl-system.md#acl-agent-token) section for more details |
| [`acl.tokens.master`](https://www.consul.io/docs/agent/options#acl_tokens_master) | `OPTIONAL` | `N/A` | Special token used to bootstrap the ACL system, check the [Bootstrapping ACLs](https://learn.hashicorp.com/tutorials/consul/access-control-setup-production) tutorial for more details |
| [`acl.tokens.default`](https://www.consul.io/docs/agent/options#acl_tokens_default) | `OPTIONAL` | `OPTIONAL` | Default token to use for client requests where no token is supplied; this is often configured with read-only access to services to enable DNS service discovery on agents |

All of these tokens except the `master` token can all be introduced or updated via the [/v1/agent/token API](https://www.consul.io/api/agent#update-acl-tokens).

#### [»](acl-system.md#acl-agent-master-token)ACL Agent Master Token

Since the [`acl.tokens.agent_master`](https://www.consul.io/docs/agent/options#acl_tokens_agent_master) is designed to be used when the Consul servers are not available, its policy is managed locally on the agent and does not need to have a token defined on the Consul servers via the ACL API. Once set, it implicitly has the following policy associated with it

```text
agent "" {
  policy = "write"
}
node_prefix "" {
  policy = "read"
}
```

#### [»](acl-system.md#acl-agent-token)ACL Agent Token

The [`acl.tokens.agent`](https://www.consul.io/docs/agent/options#acl_tokens_agent) is a special token that is used for an agent's internal operations. It isn't used directly for any user-initiated operations like the [`acl.tokens.default`](https://www.consul.io/docs/agent/options#acl_tokens_default), though if the `acl.tokens.agent_token` isn't configured the `acl.tokens.default` will be used. The ACL agent token is used for the following operations by the agent:

1. Updating the agent's node entry using the [Catalog API](https://www.consul.io/api/catalog), including updating its node metadata, tagged addresses, and network coordinates
2. Performing [anti-entropy](https://www.consul.io/docs/internals/anti-entropy) syncing, in particular reading the node metadata and services registered with the catalog
3. Reading and writing the special `_rexec` section of the KV store when executing [`consul exec`](https://www.consul.io/commands/exec) commands

Here's an example policy sufficient to accomplish the above for a node called `mynode`:

```text
node "mynode" {
  policy = "write"
}
service_prefix "" {
  policy = "read"
}
key_prefix "_rexec" {
  policy = "write"
}
```

The `service_prefix` policy needs read access for any services that can be registered on the agent. If [remote exec is disabled](https://www.consul.io/docs/agent/options#disable_remote_exec), the default, then the `key_prefix` policy can be omitted.

## [»](acl-system.md#next-steps)Next Steps

Setup ACLs with the [Bootstrapping the ACL System tutorial](https://learn.hashicorp.com/tutorials/consul/access-control-setup-production?utm_source=consul.io&utm_medium=docs) or continue reading about [ACL rules](https://www.consul.io/docs/acl/acl-rules).

